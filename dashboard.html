<!DOCTYPE html>
<html>
<head>
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
apiKey: "AIzaSyCRKV93NJ7YX1zP7xAiG340mTXDTIEweaQ",
authDomain: "masjid-shabaab.firebaseapp.com",
databaseURL: "https://masjid-shabaab-default-rtdb.firebaseio.com/",
projectId: "masjid-shabaab",
storageBucket: "masjid-shabaab.firebasestorage.app",
messagingSenderId: "590758366670",
appId: "1:590758366670:web:2fe678c410285fab5fef9f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* üîê LOGIN PROTECTION */
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get("auth") !== "ok"){
window.location.href = "admin.html";
}

/* ================= LOAD AUDIO ================= */

window.loadAudios = function(){

const dbRef = ref(db,"audios");

onValue(dbRef,(snapshot)=>{
const list = document.getElementById("audioList");
list.innerHTML = "";

snapshot.forEach(child => {

const data = child.val();

list.innerHTML += `
<div style="border:1px solid #ccc;padding:10px;margin:10px;">
<h4>${data.title}</h4>
<p>Category: ${data.category}</p>
<audio controls>
<source src="${data.audio}">
</audio>
<br><br>
<button onclick="deleteAudio('${child.key}')">Delete</button>
</div>
`;

});
});

}

window.deleteAudio = function(id){
remove(ref(db,"audios/"+id));
alert("Deleted ‚úÖ");
}

window.onload = loadAudios;

</script>

</head>
<body>

<h2>üî• Admin Dashboard</h2>

<h3>Upload Audio</h3>

<input type="text" id="title" placeholder="Audio Title"><br><br>

<select id="category">
<option value="Khutbah">Khutbah</option>
<option value="Jumamosi">Jumamosi</option>
<option value="Jumapili">Jumapili</option>
<option value="Ramadhani">Ramadhani</option>
</select><br><br>

<input type="file" id="audioFile" accept="audio/*"><br><br>

<button onclick="uploadToCloudinary()">Upload Audio</button>

<hr>

<h3>Audio List</h3>
<div id="audioList"></div>

<script>

/* ================= CLOUDINARY UPLOAD ================= */

async function uploadToCloudinary(){

const fileInput = document.getElementById("audioFile");
const title = document.getElementById("title").value;
const category = document.getElementById("category").value;

const file = fileInput.files[0];

if(!file){
alert("Select Audio File");
return;
}

const formData = new FormData();
formData.append("file", file);
formData.append("upload_preset", "UPLOAD_PRESET_YAKO");

try{

const response = await fetch(
"https://api.cloudinary.com/v1_1/drlltmnlb/upload",
{
method:"POST",
body:formData
}
);

const data = await response.json();

const audioUrl = data.secure_url;

/* Save To Firebase Realtime */
push(ref(db,"audios"),{
title:title,
category:category,
audio:audioUrl
});

alert("Uploaded Successfully ‚úÖ");

fileInput.value = "";
document.getElementById("title").value = "";

}catch(error){
alert("Upload Failed ‚ùå\n" + error.message);
console.log(error);
}

}

</script>

</body>
</html>
